<canvas id="canvas" width="750" height="750"></canvas>
<script>
    window.onload = () => {
        canvas = document.getElementById("canvas")
        width = canvas.width
        height = canvas.height
        cx = width / 2
        cy = height / 2
        ctx = canvas.getContext("2d")
        g = 1
        pends = [
            { length: 100, x: 0, y: 0, angle: {velocity: 0, accel: 0, theta: Math.PI/2} , mass: 10 },
            { length: 100, x: 0, y: 0, angle: {velocity: 0, accel: 0, theta: Math.PI/4}, mass: 10 },
            { length: 100, x: 0, y: 0, angle: {velocity: 0, accel: 0, theta: Math.PI/4}, mass: 10 }
        ]
        root = pends[0]
        for(var i=1; i<pends.length; i++){
            pends[i].parent = pends[i-1]
        }

        setInterval(loop, 1000/30);
    }

    function loop() {
        calcBaseAngle(root, pends[1])
        pends
            .filter(pend => pend.parent)
            .forEach(pend => calcChildAngle(pend, pend.parent))

        applyForces()
        setPositions()
        resetContext()
        draw()
    }

    function calcBaseAngle(pend, child) {
        let part1 = -g * (2*pend.mass+child.mass) * Math.sin(pend.angle.theta)
        let part2 = -child.mass * g * Math.sin(pend.angle.theta-2*child.angle.theta)
        let part3 = -2*Math.sin(pend.angle.theta-child.angle.theta)*child.mass
        let part4 = child.angle.velocity*child.angle.velocity*child.length+pend.angle.velocity*pend.angle.velocity*pend.length*Math.cos(pend.angle.theta-child.angle.theta)
        let den = pend.length * (2*pend.mass+child.mass-child.mass*Math.cos(2*pend.angle.theta-2*child.angle.theta))
        pend.angle.accel = (part1+part2+part3*part4)/den
    }

    function calcChildAngle(child, parent) {
        let part1 = 2 * Math.sin(parent.angle.theta-child.angle.theta)
        let part2 = (parent.angle.velocity*parent.angle.velocity*parent.length*(parent.mass+child.mass))
        let part3 = g*(parent.mass+child.mass)*Math.cos(parent.angle.theta)
        let part4 = child.angle.velocity*child.angle.velocity*child.length*child.mass*Math.cos(parent.angle.theta-child.angle.theta)
        let den = child.length * (2*parent.mass+child.mass-child.mass*Math.cos(2*parent.angle.theta-2*child.angle.theta))
        child.angle.accel = (part1*(part2+part3+part4))/den
    }

    function applyForces(){
        pends.forEach(pend => {
            pend.angle.velocity += pend.angle.accel
            pend.angle.theta += pend.angle.velocity
        })
    }

    function setPositions(){
        root.x = root.length * Math.sin(root.angle.theta);
        root.y = root.length * Math.cos(root.angle.theta);
        
        pends
            .filter(pend => pend.parent)
            .forEach(pend =>{
                pend.x = pend.parent.x + pend.length * Math.sin(pend.angle.theta);
                pend.y = pend.parent.y + pend.length * Math.cos(pend.angle.theta);
            })
    }

    function resetContext(){
        ctx.resetTransform()
        ctx.fillStyle = 'red'
        ctx.fillRect(0, 0, width, height);
    }

    function draw(){
        ctx.strokeStyle = 'black'
        ctx.translate(cx, cy);

        ctx.beginPath()
        ctx.moveTo(0, 0)
        pends.forEach(pend => ctx.lineTo(pend.x, pend.y))
        ctx.stroke()
        
        ctx.fillStyle = 'black'
        pends.forEach(pend => {
            ctx.beginPath()
            ctx.arc(pend.x,pend.y,pend.mass,0,2*Math.PI)
            ctx.fill()
        })
    }
</script>