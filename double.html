<canvas id="canvas" width="750" height="750"></canvas>
<script>
    window.onload = () => {
        canvas = document.getElementById("canvas")
        width = canvas.width
        height = canvas.height
        cx = width / 2
        cy = height / 2
        ctx = canvas.getContext("2d")
        g = 1
        pend1 = { length: 100, x: 0, y: 0, angle: {velocity: 0, accel: 0, theta: Math.PI/2} , mass: 10 }
        pend2 = { parent: pend1, length: 100, x: 0, y: 0, angle: {velocity: 0, accel: 0, theta: Math.PI/4}, mass: 10 }
        pend3 = { parent: pend2, length: 100, x: 0, y: 0, angle: {velocity: 0, accel: 0, theta: Math.PI/4}, mass: 10 }
        pends = [pend1, pend2, pend3]
        setInterval(loop, 1000/30);
    }

    function loop() {
        calcBaseAngle()
        pends.forEach(pend => {
            if(pend.parent)
                calcChildAngle(pend, pend.parent)
        });
        applyForces()
        setPositions()
        resetContext()
        draw()
    }

    function calcBaseAngle() {
        let part1 = -g * (2*pend1.mass+pend2.mass) * Math.sin(pend1.angle.theta)
        let part2 = -pend2.mass * g * Math.sin(pend1.angle.theta-2*pend2.angle.theta)
        let part3 = -2*Math.sin(pend1.angle.theta-pend2.angle.theta)*pend2.mass
        let part4 = pend2.angle.velocity*pend2.angle.velocity*pend2.length+pend1.angle.velocity*pend1.angle.velocity*pend1.length*Math.cos(pend1.angle.theta-pend2.angle.theta)
        let den = pend1.length * (2*pend1.mass+pend2.mass-pend2.mass*Math.cos(2*pend1.angle.theta-2*pend2.angle.theta))
        pend1.angle.accel = (part1+part2+part3*part4)/den
    }

    function calcChildAngle(child, parent) {
        let part1 = 2 * Math.sin(parent.angle.theta-child.angle.theta)
        let part2 = (parent.angle.velocity*parent.angle.velocity*parent.length*(parent.mass+child.mass))
        let part3 = g*(parent.mass+child.mass)*Math.cos(parent.angle.theta)
        let part4 = child.angle.velocity*child.angle.velocity*child.length*child.mass*Math.cos(parent.angle.theta-child.angle.theta)
        let den = child.length * (2*parent.mass+child.mass-child.mass*Math.cos(2*parent.angle.theta-2*child.angle.theta))
        child.angle.accel = (part1*(part2+part3+part4))/den
    }

    function applyForces(){
        pends.forEach(pend => {
            pend.angle.velocity += pend.angle.accel
            pend.angle.theta += pend.angle.velocity
        })
    }

    function setPositions(){
        pend1.x = pend1.length * Math.sin(pend1.angle.theta);
        pend1.y = pend1.length * Math.cos(pend1.angle.theta);
        
        pends.forEach(pend =>{
            if(pend.parent){
                pend.x = pend.parent.x + pend.length * Math.sin(pend.angle.theta);
                pend.y = pend.parent.y + pend.length * Math.cos(pend.angle.theta);
            }
        })
    }

    function resetContext(){
        ctx.resetTransform()
        ctx.fillStyle = 'red'
        ctx.fillRect(0, 0, width, height);
    }

    function draw(){
        ctx.strokeStyle = 'black'
        ctx.translate(cx, cy);

        ctx.beginPath()
        ctx.moveTo(0, 0)
        pends.forEach(pend => ctx.lineTo(pend.x, pend.y))
        ctx.stroke()
        
        ctx.fillStyle = 'black'
        pends.forEach(pend => {
            ctx.beginPath()
            ctx.arc(pend.x,pend.y,pend.mass,0,2*Math.PI)
            ctx.fill()
        })
    }
</script>